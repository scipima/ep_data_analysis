---
title: "EP Political Groups' Metrics"
author:
  - Marco SCIPIONI
date: "`r Sys.Date()`"
format: 
 html:
   embed-resources: true
   toc: true
   toc-depth: 3
   toc-title: Contents
   number-sections: true
   colorlinks: true
editor_options: 
  chunk_output_type: console
execute:
  echo: false
  warning: false
---

## Intro
```{r}
#| include: false

script_starts <- Sys.time()

###--------------------------------------------------------------------------###
## Libraries -------------------------------------------------------------------
if ( !require("pacman") ) install.packages("pacman")
pacman::p_load(char = c("data.table", "dplyr", "forcats", "ggplot2", "here",
                        "lubridate", "janitor", "stringr", "tidyr", "tidyselect",
                        "tidytext") )


# Hard code the start of the mandate ------------------------------------------#
mandate_starts <- "2024-07-14"


###--------------------------------------------------------------------------###
## Functions -------------------------------------------------------------------

# Mode ------------------------------------------------------------------------#
# https://stackoverflow.com/questions/2547402/how-to-find-the-statistical-mode
stat_mode <- function(x) {
  if ( length(x) <= 2 ) return(x[1])
  if ( anyNA(x) ) x = x[!is.na(x)]
  ux <- unique(x)
  ux[ which.max( tabulate( match(x, ux) ) ) ] }

# Load join functions ---------------------------------------------------------#
source(file = here::here("scripts_r", "join_functions.R") )

# Calculate Majorities --------------------------------------------------------#
source(file = here::here("scripts_r", "get_majority.R") )


#------------------------------------------------------------------------------#
## Graphics --------------------------------------------------------------------
# set theme globally for ggplots ----------------------------------------------#
# https://stackoverflow.com/questions/34522732/changing-fonts-in-ggplot2
theme_set(theme_minimal(base_size = 10, base_family = "roboto") )

#------------------------------------------------------------------------------#
# vote colours ----------------------------------------------------------------#
vote_colours <- c(For = '#00AEEF',
                  Against = '#BE3455',
                  Abstain = "#969696",
                  `Did not vote` = '#5D5CA4',
                  Absent = '#F47920')

# political groups colours ----------------------------------------------------#
polgroup_cols = c(`S&D` = "#EE3652",
                  ECR = "#0D88C3",
                  PfE = "#1A3153",
                  PPE = "#3C5979",
                  Renew = "#FFCC70",
                  `Verts/ALE` = "#19A24A",
                  `The Left` = "#733542",
                  ESN = "#000000",
                  NI = "#979797")
```

The objective of this short note is to investigate legislative trends during the EP's current mandate.

**Please keep in mind** that this document is the *sole property of the Renew Group* and *should not be disseminated to other people or organisations*.


## Data and Methods
```{r}
#| include: false

###--------------------------------------------------------------------------###
## Read data -------------------------------------------------------------------
# Subset to just 9th mandate
meps_rcv_mandate <- data.table::fread(
  file = here::here("data_out", "meps_rcv_mandate_10.csv"),
  verbose = TRUE, key = c("rcv_id", "pers_id"), na.strings = c(NA_character_, "") )
pl_votes <- data.table::fread(
  file = here::here("data_out", "votes", "pl_votes_10.csv"), 
  # select = c("activity_date", "rcv_id", "mandate", "number_of_attendees", 
  #            "number_of_votes_abstention", "number_of_votes_against",
  #            "number_of_votes_favor"),
  na.strings = c(NA_character_, "") 
)

meps_current = data.table::fread(here::here(
  "data_out", "meps", "meps_current.csv") )

#------------------------------------------------------------------------------#
# get length objects
n_votes <- nrow(pl_votes)
n_rcv <- length( unique( meps_rcv_mandate$rcv_id ) )


#------------------------------------------------------------------------------#
# Parameters -------------------------------------------------------------------
renew_polgroup_id <- 7035L

renew_current_meps = unique(meps_current$pers_id[
  meps_current$polgroup_id == renew_polgroup_id
])
```

We include in our analysis all voting data relative to roll-call votes (RCVs) since `r mandate_starts`.
To provide some context, we currently have `r length(unique(meps_rcv_mandate$rcv_id))` RCVs in our database.
It is important to appreciate that what we have is only a subset of the all legislation being adopted. 
Indeed, the EP recognises different forms of voting - such as *raise of hands*, or *electronic votes* - but RCVs are the only ones where we able to trace votes to individual MEPs - that is, they are so-called *nominal* votes. 
Since the start of the current mandate, RCVs were approximately `r round(n_rcv/n_votes*100, digits=1)`% of the total votes.


## Affinity: Group Level
### Overall
```{r}
#------------------------------------------------------------------------------#
# Recode
vote_dict <- data.table::fread(here::here("data_out", "votes", "vote_dict.csv") )
# left join
# dim(meps_rcv_mandate)
meps_rcv_mandate <- vote_dict[meps_rcv_mandate, on = "result"]
# dim(meps_rcv_mandate)
meps_rcv_mandate[, result_fct := as.factor(result_fct)]

#------------------------------------------------------------------------------#
# Get House majority - only official results
house_mjrt <- get_house_majority(data_in = meps_rcv_mandate[result >= -1L])
# Get the Groups' majority by rcv_id - only official results
polgroups_mjrt <- get_polgroup_majority(data_in = meps_rcv_mandate[result >= -1L])
# Just Renew Mjrt
renew_mjrt <- polgroups_mjrt[polgroup_id == renew_polgroup_id]

#------------------------------------------------------------------------------#
# Merge
renew_polgroups_mjrt <- merge(
  x = renew_mjrt[, list(rcv_id, result, who_won)],
  y = polgroups_mjrt,
  by = c("rcv_id"), all = FALSE)
renew_polgroups_mjrt[, is_same := as.integer( result.x == result.y ) ]
renew_polgroups_mjrt <- renew_polgroups_mjrt[ !is.na(is_same) ] |> 
  join_polit_labs()
# sapply(renew_polgroups_mjrt, function(x) sum(is.na(x))) # check

# Because of ties within Groups (i.e. absence of a majority), we may lose some votes. 
# How many lost RCVs due to ties?
# sum(!unique(meps_rcv_mandate$rcv_id) %in% unique(renew_polgroups_mjrt$rcv_id))
```

We first calculate the overall affinity of all other Groups to Renew, unfiltered.
Affinity is defined as the rate with which either the *majorities within Groups/national parties* vote in the same way, or *MEPS* vote in the same way. 
Here we use only EP official types of votes.^[Because of ties within Groups (i.e. absence of a majority), we may lose some votes. Indeed, we made the choice of discarding the votes where an EP Political Group/National Party did not express a majority.]

To illustrate how the metric works with a toy example, imagine we have four EPP MEPs, and we want to check their affinity with Renew's majority in the context of three RCVs.
```{r}
toy_example <- tibble::tibble(
  `RCV Number` = rep(x = 1:3, times=4),
  `Renew Majority` = rep(x = c("For", "Against", "Abstain"), times=4),
  `EPP MEP` = rep(x = c("Mario", "Luigi", "Peach", "Bowser"), each = 3),
  `EPP MEP's vote` = c("For", "Against", "Abstain",
                       "For", "Against", "Against",
                       "Against", "Against", "Against",
                       "Against", "For", "Against") ) |> 
  dplyr::mutate(`Match?` = ifelse(
    test = `Renew Majority` == `EPP MEP's vote`, yes = 1L, no = 0L) )

knitr::kable(toy_example, align = "c")
```

Given this table, the resulting metrics for these EPP MEPs would be as follows
```{r}
toy_example |> 
  dplyr::group_by(`EPP MEP`) |> 
  dplyr::summarise(Affinity = round( mean(`Match?`) * 100, digits = 1) ) |> 
  dplyr::ungroup() |> 
  dplyr::arrange(desc(Affinity) ) |> 
  knitr::kable(align = "c")
```

Coming back to the actual data for this mandate, what's the overall picture?
```{r}
#| fig-width: 8
#| fig-height: 3

# get the mean
renew_polgroups_mjrt[!is.na(is_same),
                     list(affinity = mean(is_same)),
                     by = list(political_group)] |> 
  # drop renew identity
  dplyr::filter(political_group != "Renew") |> 
  dplyr::mutate(political_group = fct_reorder(political_group, affinity)) |> 
  ggplot(aes(x=political_group, y = affinity, fill = political_group)) +
  geom_col(colour = "black", linewidth = 0.1) +
  geom_text(aes(label = round(affinity*100, digits = 1)), size = 3, nudge_y = 0.03) +
  coord_flip() +
  labs(
    x="", y="Affinity with Renew (%)", fill="",
    title = str_wrap(
      "How often does the majority within other Political Group happen to vote alongside Renew's majority?",
      width = 88),
    caption = paste0(
      "Source: EP. Notes: data is relative to RCVs in Plenary. Refreshed on: ",
      Sys.Date() ) ) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = polgroup_cols) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "none",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold"))
```


### Committees
```{r}
#------------------------------------------------------------------------------#
# List of RCV IDs and Committees
rcvid_cmts <- data.table::fread(here::here(
  "data_out", "rcv", "rcvid_cmts_10.csv") )
rcvid_cmts[committee_lab == "BUDE", committee_lab := "BUDG"]

# Number of RCVs
# length( unique(meps_rcv_mandate$rcv_id) )
# Number of RCVs by Committee (check for Joint Committee)
# rcvid_cmts[, .N, by = rcv_id][order(N)]

# what are the RCVs without DOC ID?
rcv_missing_doc <- unique(meps_rcv_mandate$rcv_id)[
  !unique(meps_rcv_mandate$rcv_id) %in% unique(rcvid_cmts$rcv_id)]

# These should be ordre du jour, election of commission, etc.
# pl_votes[rcv_id %in% rcv_missing_doc]
```

In this sub-section, we break down the aggregate trends witnessed above by Committees.
Please be aware that, because *many Resolutions are not associated with a Committee*, and *no Joint Resolution is associated with a Committee*, only a subset of votes are analysed here. 
More precisely, while there are `r n_rcv` RCVs in this mandate, only `r n_rcv - length(rcv_missing_doc)` of those can be traced back to a Committee (`r round( ( ( n_rcv - length(rcv_missing_doc) ) / n_rcv ) * 100, digits=1)`%). 
Further, because an individual report may be associated with multiple Committees (i.e. in the *Joint Committees*), we decided to count these vote in every Committee where they appear, thus resulting to some degree in double counting. 
```{r}
#| fig-width: 8
#| fig-height: 13

#------------------------------------------------------------------------------#
renew_polgroups_mjrt_cmt <- renew_polgroups_mjrt[
  rcvid_cmts,
  on = "rcv_id", nomatch = NULL
]
# renew_polgroups_mjrt_cmt[, .N, by = "rcv_id"][order(N)]

# Plot ------------------------------------------------------------------------#
renew_polgroups_mjrt_cmt[
  !is.na(is_same) # Get rid of NAs
  & !is.na(committee_lab) # just Standing Committees
  & polgroup_id != 7035L, # Get rid of Renew identity
  # Calculate the mean --------------------------------------------------------#
  list(n_votes = .N,
       affinity = mean(is_same) ),
  # Grouped by Political Group and Committee ----------------------------------#
  by = list(political_group, committee_lab) ] |> 
  # dplyr::filter(political_group != "Renew") |> 
  dplyr::mutate(political_group_rw = reorder_within(
    x = political_group, by = affinity, within = committee_lab) ) |> 
  ggplot(aes(x=political_group_rw, y = affinity, # alpha = n_votes, 
             fill = political_group) ) +
  geom_col(colour = "black", linewidth = 0.1) +
  facet_wrap(~committee_lab, scales = "free_y", ncol = 2) +
  coord_flip() +
  labs(
    x="", y="Affinity with Renew (%)", fill="",
    title = str_wrap(
      "How often does the majority within other Political Group happen to vote alongside Renew's majority, by Committee?",
      width = 88),
    caption = "Source: EP. Notes: data is relative to RCVs in Plenary") +
  scale_x_reordered() +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = polgroup_cols) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "none",
        strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold"))  
```


### Cumulative Affinity
```{r}
#| fig-width: 8
#| fig-height: 9.5

# Affinity --------------------------------------------------------------------#
rcvid_date <- unique(
  pl_votes[, list(date = activity_date, rcv_id)]
)
last_pl_month = lubridate::month( max(pl_votes$activity_date), 
                                  label = TRUE, abbr = TRUE)
last_pl_year = data.table::year( max(pl_votes$activity_date) )
month_year = paste(last_pl_month, last_pl_year, sep = " ")

is_same = renew_mjrt[
  polgroups_mjrt[polgroup_id != renew_polgroup_id],
  on = "rcv_id"
][
  , `:=`(
    is_same = as.integer(result == i.result)
  )
][
  !is.na(is_same)
]
# unique(is_same$rcv_id[is.na(is_same$polgroup_id)])

is_same_date = is_same[
  rcvid_date,
  on = "rcv_id", nomatch = NULL
]
data.table::setkeyv(x = is_same_date,
                    cols = c("date", "rcv_id", "polgroup_id"))

is_same_date[, 
             `:=`(
               cum_same = dplyr::cummean(is_same)
             ),
             by = list(i.polgroup_id)
] 

last_value = is_same_date |> 
  dplyr::slice_tail(n = 1, by = i.polgroup_id) |> 
  dplyr::select(date, rcv_id, is_same, cum_same,
                polgroup_id = i.polgroup_id) |> 
  join_polit_labs() |> 
  dplyr::filter(political_group != "NI") |> 
  dplyr::mutate(
    rcv_id = as.factor(rcv_id),
    political_group = factor(political_group, 
                             levels = c("Renew", "PPE", "S&D", "Verts/ALE",
                                        "ECR", "The Left", "PfE", "ESN") ) 
  ) 


is_same_date |> 
  dplyr::select(date, rcv_id, is_same, cum_same,
                polgroup_id = i.polgroup_id) |> 
  join_polit_labs()  |> 
  dplyr::filter(political_group != "NI") |> 
  dplyr::arrange(date, rcv_id) |> 
  dplyr::mutate(
    rcv_id = as.factor(rcv_id),
    political_group = factor(political_group, 
                             levels = c("Renew", "PPE", "S&D", "Verts/ALE",
                                        "ECR", "The Left", "PfE", "ESN") ) 
  ) |>
  ggplot(aes(x = rcv_id, y = cum_same, group = political_group,
             colour = political_group, fill = political_group) ) +
  geom_point(alpha = 0.1, show.legend = FALSE) +
  geom_smooth(show.legend = FALSE) +
  geom_text(
    data = last_value, 
    aes(x = rcv_id, y = cum_same, label = round(cum_same*100, 1)),
    colour="black", hjust = 1.2, vjust = -0.8) +
  facet_wrap(~political_group, nrow=4) + # change this 2 if printing pdf
  scale_x_discrete(
    breaks = c(as.character(min(is_same$rcv_id)),
               as.character(max(is_same$rcv_id))),
    labels = c("July 2024", month_year) ) +
  labs(x="Time", y="Cumulative Average Similarity") +
  scale_y_continuous(labels = scales::percent) +
  scale_colour_manual(values = polgroup_cols) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust=c(0,1)),
    panel.spacing.x = unit(5, "mm")
  )
# ggsave(filename = here::here("figures", "cumulative_affinity_allgroups.pdf"),
#        device = "pdf", dpi = 300, height = 7, width = 12.5)
```


## Cohesion Rates
The formula for cohesion is taken from [Is there a selection bias in roll call votes?](http://link.springer.com/10.1007/s11127-018-0529-1)

$COHESION_{ij} = \frac{max[Y_{ij}, N_{ij}, A_{ij}] - 0.5[(Y_{ij} + N_{ij} + A_{ij}) - max[Y_{ij}, N_{ij}, A_{ij}]]}{(Y_{ij} + N_{ij} + A_{ij})}$

To develop an intuition for how this metric works, please consider the 6 simplified scenarios in the table below.
In each row, a party of different size (namely, 2, 3, and 4 MEPs) has a different distribution of votes internally. 
The rightmost column provides the cohesion rate for each of these cases.
```{r}
knitr::kable(
  tibble::tibble(
    `Number of MEPs` = c(2, 2, 3, 3, 4, 4),
    `Vote: For` = c(2, 1, 2, 1, 2, 3),
    `Vote: Against` = c("-", 1, 1, 1, 1, 1),
    `Vote: Abstain` = c("-", "-", "-", 1, 1, "-"), 
    Cohesion = c(100, 25, 50, 0, 25, 62.5),
    # `Is split?` = c("No", "Yes", "No", "Yes", "Yes", "No")
  ), 
  align = "c")
```

As a *technical side note*, please be aware that this basically picks the mode of the 3 typologies of vote officially recognised in the EP. 
However, experts have highlighted other forms of vote are actually at the MEPs' disposal, i.e. being present in the House but not showing up for specific votes (`no_vote`), or being absent on the voting day (`absent`).
We do not count those in this note, but can be included if needs be.
Further, and to be clear, here we do not make use of data coming from the Attendance Registers, but these can be included if needs be.


### Overall cohesion rates
```{r}
#| fig-width: 8
#| fig-height: 3

###--------------------------------------------------------------------------###
# Read in function
source(file = here::here("scripts_r", "cohesionrate_function.R") )
# convert to factor - essential for tabulate
meps_rcv_mandate[, result_fct := factor(result,
                                        levels = -3L : 1L,
                                        labels = c("absent", "no_vote", "against",
                                                   "abstain", "for") ) ]
# Check
# table(meps_rcv_mandate$result, meps_rcv_mandate$result_fct, exclude = NULL)

# Calculate Cohesion
cohesion_dt <- meps_rcv_mandate[
  result >= -1L, # only official votes
  list(
    cohesion = cohesion_hn(result_fct),
    max_mode = max( tabulate(result_fct) ),
    tot_votes = sum( tabulate(result_fct) ) ), 
  keyby = list(rcv_id, polgroup_id) ] |> 
  join_polit_labs()

cohesion_dt[, .(avg = round( mean(cohesion, na.rm = TRUE), digits = 1)), 
            by = list(political_group)][order(-avg)] |> 
  dplyr::mutate(political_group = fct_reorder(.f = political_group, .x = avg)) |> 
  ggplot(aes(x=political_group, y = avg, fill = political_group)) +
  geom_col(colour = "black", linewidth = 0.1) +
  geom_text(aes(label = avg), size = 3, nudge_y = 3) +
  coord_flip() +
  labs(x="", y="Average Cohesion Rates (%)", fill="",
       title = "Cohesion Rates by EP Political Groups",
       caption = "Source: EP. Notes: data is relative to RCVs in Plenary") +  
  scale_fill_manual(values = polgroup_cols) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "none",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold"))
# ggsave(filename = here::here("figures", "cohesion_bypolgroup_avg.pdf"), 
#        device = "pdf", dpi = 300, height = 8, width = 12)
```


### Cohesion Rates by Final
```{r}
#| fig-width: 8
#| fig-height: 5

#------------------------------------------------------------------------------#
# Final Votes data ------------------------------------------------------------#
votes_final_all <- data.table::fread( here::here(
  "data_out", "votes", "votes_final_10.csv") )

# Merge RCV with Finals -------------------------------------------------------#
meps_rcv_mandate <- votes_final_all[meps_rcv_mandate, on = "rcv_id"]

# Colours ---------------------------------------------------------------------#
cols_final <- c(Final = "#0868ac", `Not Final` = "#d7301f")

# Calculate final votes -------------------------------------------------------#
cohesion_final_dt <- meps_rcv_mandate[
  result >= -1L, # only official votes
  list(
    cohesion = cohesion_hn(result_fct),
    max_mode = max(tabulate(result_fct)),
    tot_votes = sum(tabulate(result_fct) ) ),
  keyby = list(rcv_id, polgroup_id, is_final) ] |> 
  join_polit_labs()

# Plot -------------------------------------------------------------------------
# REF: https://stackoverflow.com/questions/40211451/geom-text-how-to-position-the-text-on-bar-as-i-want
cohesion_final_avg <- cohesion_final_dt[, list(
  avg = round( mean(cohesion, na.rm = TRUE), digits = 1)), 
  by = list(political_group, is_final)][order(avg)]

# Extract rank vector for plot
plot_rank <- cohesion_final_avg$political_group[
  cohesion_final_avg$is_final == 1L]

cohesion_final_avg |> 
  dplyr::mutate(
    is_final = ifelse(test = is_final == 1L,
                      yes = "Final", no = "Not Final"), 
    is_final = factor(is_final, levels = c("Final", "Not Final") ) ) |> 
  ggplot(aes(x = factor(political_group, levels = plot_rank), y = avg) ) +
  geom_col(aes(fill = is_final, group = is_final),
           colour = "black", linewidth = 0.1, position = "dodge") +
  geom_text(aes(label = avg, group = is_final), size = 3,
            hjust = -0.1, position = position_dodge(width = 1), inherit.aes = TRUE) +
  scale_fill_manual(values = cols_final) +
  coord_flip() +
  labs(x="", y="Average Cohesion Rates (%)", fill="",
       title = "Cohesion Rates by EP Political Groups",
       caption = "Source: EP. Notes: data is relative to RCVs in Plenary") +  
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "top",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold") )
# ggsave(filename = here::here("figures", "cohesion_bypolgroup_avg.pdf"), 
#        device = "pdf", dpi = 300, height = 8, width = 12)
```


### Cohesion Rates by Committee
```{r}
#| fig-width: 8
#| fig-height: 13

#------------------------------------------------------------------------------#
cohesion_bycommittee <- rcvid_cmts[
  cohesion_dt,
  on = "rcv_id", nomatch = NULL
] 

cohesion_bycommittee[
  !is.na(committee_lab),
  list(avg_cohesion = mean(cohesion) ),
  by = list(political_group, committee_lab)] |> 
  dplyr::mutate(political_group_rw = reorder_within(
    political_group, avg_cohesion, committee_lab) ) |>
  ggplot(aes(x=political_group_rw, y = avg_cohesion, fill = political_group)) +
  geom_col(colour = "black", linewidth = 0.1) +
  facet_wrap(~committee_lab, scales = "free_y", ncol = 2) +
  coord_flip() +
  labs(x="", y="Average Cohesion Rates (%)", fill="",
       title = "Cohesion Rates by Committees",
       caption = "Source: EP. Notes: data is relative to RCVs in Plenary") +  
  scale_x_reordered() +
  scale_fill_manual(values = polgroup_cols) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "none",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold"))
# ggsave(filename = here::here("figures", "cohesion_bycommittee.pdf"),
#        device = "pdf", dpi = 300, height = 8, width = 12)
```

### Cumulative Cohesion Rates
```{r}
#| fig-width: 8
#| fig-height: 9.5

#------------------------------------------------------------------------------#
# All Political Groups --------------------------------------------------------#
cohesion_allpolgroups <- rcvid_date[
  meps_rcv_mandate, 
  on = "rcv_id", nomatch = NULL
][result >= -1L, # only official votes
  list(cohesion_rate = cohesion_hn(result_fct)),
  keyby = list(date, rcv_id, polgroup_id)
][!is.na(cohesion_rate), 
  `:=`(
    cum_cohesion = dplyr::cummean(cohesion_rate)
  ),
  by = list(polgroup_id)
] |> 
  join_polit_labs()

cohesion_allpolgroups[
  political_group != "NI"
][
  order(date, rcv_id)
][
  , `:=`(
    rcv_id = as.factor(rcv_id),
    political_group = factor(political_group, 
                             levels = c("Renew", "PPE", "S&D", "Verts/ALE",
                                        "ECR", "The Left", "PfE", "ESN") ) 
  )
] |>
  ggplot(aes(x = rcv_id, y = cum_cohesion, group = political_group,
             colour = political_group, fill = political_group) ) +
  geom_point(alpha = 0.1, show.legend = FALSE) +
  geom_smooth(show.legend = FALSE) +
  facet_wrap(~political_group, nrow=4) + # change this to 2 if printing pdf
  scale_x_discrete(
    breaks = c(as.character(min(cohesion_allpolgroups$rcv_id)),
               as.character(max(cohesion_allpolgroups$rcv_id))),
    labels = c("7/2024", month_year) ) +
  labs(x="Time", y="Cumulative Average Cohesion Rate") +
  scale_colour_manual(values = polgroup_cols) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(hjust=c(0,1)),
    panel.spacing.x = unit(5, "mm")
  )
# ggsave(filename = here::here("figures", "cumulative_cohesion_allgroups.pdf"),
#        device = "pdf", dpi = 300, height = 7, width = 12.5)
```


## Win Share
### Overall Winning Side
```{r}
#| fig-width: 8
#| fig-height: 3

###--------------------------------------------------------------------------###
# Get the Groups' majority by rcv_id
house_mjrt <- get_house_majority(data_in = meps_rcv_mandate[result >= -1])

###--------------------------------------------------------------------------###
# Check what party within each Group voted the same ---------------------------#
# Count votes within each party
polgroups_mjrt <- get_polgroup_majority(data_in = meps_rcv_mandate[
  result >= -1 ] ) 

###--------------------------------------------------------------------------###
## Calculate similarity --------------------------------------------------------
# Merge group line with party vote --------------------------------------------#
mjrt_house_polgroup <- merge(
  x = house_mjrt,
  y = polgroups_mjrt, 
  by = c("rcv_id"), all = FALSE) |> 
  join_polit_labs()

# Are Group and party majorities the same? ----------------------------------###
mjrt_house_polgroup[, is_same := as.integer(result.x == result.y)] 
data.table::fwrite(x = mjrt_house_polgroup[!is.na(political_group)], 
                   file = here::here("data_out", "mjrt_house_polgroup.csv"))

winshare_mean <- mjrt_house_polgroup[, list(
  avg = mean(is_same, na.rm = TRUE)),
  by = list(political_group)][order(-avg)]

# plot
winshare_mean |> 
  dplyr::mutate(political_group = fct_reorder(.f = political_group, .x = avg)) |> 
  ggplot(aes(x=political_group, y = avg, fill = political_group)) +
  geom_col(colour = "black", linewidth = 0.1) +
  geom_text(aes(label = round(avg*100, digits = 1) ), size = 3,nudge_y = 0.03) +
  coord_flip() +
  labs(
    x="", y="Winning Majority (%)", fill="",
    title = str_wrap(
      "How often does the majority within each Political Group happen to be on the winning side?", 
      width = 88),
    caption = "Source: EP. Notes: data is relative to RCVs in Plenary") +  
  scale_fill_manual(values = polgroup_cols) +
  guides(fill = guide_legend(nrow = 1)) +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "none",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold"))
# ggsave(filename = here::here("figures", "winshare_bypolgroup_avg.pdf"), 
#        device = "pdf", dpi = 300, height = 8, width = 12)
```

### Winning Side by Final
```{r}
#| fig-width: 8
#| fig-height: 5

###--------------------------------------------------------------------------###
# merge group line with party vote --------------------------------------------#
mjrt_house_polgroup <- mjrt_house_polgroup |> 
  dplyr::left_join(
    y = votes_final_all, by = "rcv_id")

winshare_mean <- mjrt_house_polgroup[, list(
  avg = mean(is_same, na.rm = TRUE)),
  by = list(political_group, is_final)][order(avg)]

# Extract rank vector for plot
plot_rank <- winshare_mean$political_group[
  winshare_mean$is_final == 1L]

# plot
winshare_mean |> 
  dplyr::mutate(
    is_final = ifelse(test = is_final == 1L,
                      yes = "Final", no = "Not Final"),
    is_final = factor(is_final, levels = c("Final", "Not Final") ) ) |> 
  ggplot(aes(x = factor(political_group, levels = plot_rank), y = avg) ) +
  geom_col(aes(fill = factor(is_final), group = factor(is_final)),
           colour = "black", linewidth = 0.1, position = "dodge") +
  geom_text(aes(label = round(avg*100, digits = 1), group = factor(is_final)),
            size = 3,
            hjust = -0.1, position = position_dodge(width = 1), inherit.aes = TRUE) +
  scale_fill_manual(values = cols_final) +
  coord_flip() +
  labs(
    x="", y="Winning Majority (%)", fill="",
    title = str_wrap(
      "How often does the majority within each Political Group happen to be on the winning side?", 
      width = 88),
    caption = "Source: EP. Notes: data is relative to RCVs in Plenary") +  
  guides(fill = guide_legend(nrow = 1)) +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "top",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold"))
# ggsave(filename = here::here("figures", "winshare_bypolgroup_avg.pdf"), 
#        device = "pdf", dpi = 300, height = 8, width = 12)
```


### Winning Side by Committee
```{r}
#| fig-width: 8
#| fig-height: 13

###--------------------------------------------------------------------------###
winshare_bycommittee <- rcvid_cmts[
  mjrt_house_polgroup,
  on = "rcv_id", nomatch = NULL
]

winshare_bycommittee_avg = winshare_bycommittee[
  !is.na(committee_lab),
  list(avg = mean(is_same, na.rm = TRUE) ),
  by = list(political_group, committee_lab)] 


winshare_bycommittee_avg |> 
  dplyr::mutate(
    political_group_rw = reorder_within(political_group, avg, committee_lab)
    # political_group = fct_reorder(political_group, avg)
  ) |>
  ggplot(aes(x=political_group_rw, y = avg, fill = political_group)) +
  geom_col(colour = "black", linewidth = 0.1) +
  # geom_text(aes(label = round(avg*100, digits = 1)), size = 3, nudge_y = 0.05) +
  facet_wrap(~committee_lab, scales = "free_y", ncol = 2) +
  coord_flip() +
  labs(
    x="", y="Winning Majority (%)", fill="",
    title = str_wrap(
      "How often does the majority within each Political Group happen to be on the winning side?", 
      width = 88),
    caption = "Source: EP. Notes: data is relative to RCVs in Plenary") +  
  scale_x_reordered() +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = polgroup_cols) +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "none",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold"))
# ggsave(filename = here::here("figures", "winshare_bypolgroup_by_committee_avg.pdf"), 
#        device = "pdf", dpi = 300, height = 8, width = 12)
```

```{r reproducibility}
sessionInfo()

script_ends <- Sys.time()
print(script_ends - script_starts) # running time
```
