---
title: "MEPs' Cumulative Alignment"
format: 
  pdf:
    number-sections: true
    number-depth: 2
    shift-heading-level-by: -1
    colorlinks: true
    geometry:
      - top=5mm
      - right=10mm
      - bottom=20mm
      - left=10mm
      - heightrounded
editor_options: 
  chunk_output_type: console
execute:
  echo: false
  warning: false
---

## Introduction
```{r}
#| include: false

#------------------------------------------------------------------------------#
## Libraries -------------------------------------------------------------------
library(tidyverse)
library(tidytext)
library(data.table)
library(here)

# Hard code the start of the mandate ------------------------------------------#
mandate_starts <- "2024-07-14"
current_month = lubridate::month(x = Sys.Date(), label = TRUE, abbr = FALSE)
current_year = lubridate::year( x = Sys.Date() )


#------------------------------------------------------------------------------#
## Functions -------------------------------------------------------------------

# Mode ------------------------------------------------------------------------#
# https://stackoverflow.com/questions/2547402/how-to-find-the-statistical-mode
stat_mode <- function(x) {
  if ( length(x) <= 2 ) return(x[1])
  if ( anyNA(x) ) x = x[!is.na(x)]
  ux <- unique(x)
  ux[ which.max( tabulate( match(x, ux) ) ) ] }

# Load join functions ---------------------------------------------------------#
source(file = here::here("scripts_r", "join_functions.R") )

# Calculate Majorities --------------------------------------------------------#
source(file = here::here("scripts_r", "get_majority.R") )

# Cohesion rate ---------------------------------------------------------------#
source(file = here::here("scripts_r", "cohesionrate_function.R") )


#------------------------------------------------------------------------------#
## Graphics --------------------------------------------------------------------
# set theme globally for ggplots --------------------------------------------###
# https://stackoverflow.com/questions/34522732/changing-fonts-in-ggplot2
custom_theme = theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold", size = 26),
        legend.text = element_text(face="bold",  size = 22),
        plot.caption = element_text(size = 16),
        strip.text = element_text(face = "bold", size = 20, hjust = 0.5),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(colour = "grey30", linewidth = 0.1),
        panel.grid.minor.y = element_line(colour = "grey70"),
        axis.text = element_text(face="bold", size = 20),
        legend.position = "bottom")
theme_set(new = custom_theme)

# vote colours  -------------------------------------------------------------###
vote_colours <- c(For = '#00AEEF',
                  Against = '#BE3455',
                  Abstain = "#969696",
                  `Did not vote` = '#5D5CA4',
                  Absent = '#F47920')

# political groups colours ----------------------------------------------------#
polgroup_cols = c(`S&D` = "#EE3652",
                  ECR = "#0D88C3",
                  PfE = "#1A3153",
                  PPE = "#3C5979",
                  Renew = "#FFCC70",
                  `Verts/ALE` = "#19A24A",
                  `The Left` = "#733542",
                  ESN = "#000000",
                  NI = "#979797")


#------------------------------------------------------------------------------#
## Data -------------------------------------------------------------------
# Full data
meps_rcv_mandate <- data.table::fread(
  file = here::here("data_out", "meps_rcv_mandate_10.csv"),
  verbose = TRUE, key = c("rcv_id", "pers_id") )
# Nominal change from GUE to The Left
meps_rcv_mandate[polgroup_id == 5151L, polgroup_id := 6259L] 

# Votes
pl_votes <- data.table::fread(
  file = here::here("data_out", "votes", "pl_votes_10.csv"))


# List of RCV IDs and Committees
rcvid_cmts_10 <- data.table::fread(here::here(
  "data_out", "rcv", "rcvid_cmts_10.csv") )
# sort(unique(rcvid_cmts_10$committee_lab))
rcvid_cmts_10[committee_lab == "BUDE", committee_lab := "BUDG"]
rcvid_cmts_10 <- data.table::fread(here::here(
  "data_out", "rcv", "rcvid_cmts_10.csv") )
# sort(unique(rcvid_cmts_10$committee_lab))
rcvid_cmts_10[committee_lab == "BUDE", committee_lab := "BUDG"]


#------------------------------------------------------------------------------#
# Hard code Groups
renew_group_ids <- political_groups$identifier[
  political_groups$label == "Renew"]

# Current MEPs configuration
meps_current <- data.table::fread(here::here(
  "data_out", "meps", "meps_current.csv") )

renew_partyids_current = unique(meps_current$natparty_id[
  meps_current$polgroup_id %in% renew_group_ids
])
```

The objective of this note is to test a quick analysis to investigate patterns of similarity for one MEP not belonging to Renew.
We unpack similarity both *over time* and across *Committees*.
For testing purposes, we pick Manuela Ripa.


## Alignment
```{r}
###--------------------------------------------------------------------------###
# Get Groups' Majorities
mjrt_polgroup <- get_polgroup_majority(data_in = meps_rcv_mandate[
  result >= -1 
  & polgroup_id != 6561L # Exclude 'Non-attached Members'
]) 
mjrt_polgroup = mjrt_polgroup[, list(
  rcv_id, mjrt_result = result, mjrt_polgroup_id = polgroup_id
)]

# Extract combination of RCV_ID, dates, and integer for nicer plotting
rcvid_date <- unique(
  pl_votes[
    decision_method == "VOTE_ELECTRONIC_ROLLCALL"
    & !is.na(number_of_attendees)
  ][
    order(activity_date, rcv_id), 
    list(date = activity_date, rcv_id)]
)
rcvid_date[, `:=`(
  date_id = as.integer(factor(date, levels = unique(date),
                              ordered = TRUE) ),
  rcv_id_int = seq_len(.N) # get a integer as index for nicer plotting
) ]
data.table::fwrite(x = rcvid_date, file = here::here(
  "data_out", "rcv", "rcvid_date.csv") )                                          
# rcvid_date[, date := NULL]

# Extract initial and last month
last_pl_month = data.table::month( max(pl_votes$activity_date) )
last_pl_year = data.table::year( max(pl_votes$activity_date) )
month_year = paste(last_pl_month, last_pl_year, sep = "/")


###--------------------------------------------------------------------------###
# Merge Groups' Majorities with MEPs' individual votes
# dim(mjrt_polgroup)
mjrt_polgroup_meps = mjrt_polgroup[
  meps_rcv_mandate[
    pers_id %in% meps_current$pers_id
    & result >= -2L, # Exclude absent
    list(
      pers_id, rcv_id, result, polgroup_id
    )],
  on = "rcv_id", nomatch = NULL, allow.cartesian=TRUE
]
mjrt_polgroup_meps[, is_same := as.integer(result == mjrt_result)]
# dim(mjrt_polgroup_meps)

# Merge with dates as integer
mjrt_polgroup_meps = mjrt_polgroup_meps[
  rcvid_date,
  on = "rcv_id", nomatch = NULL
]
data.table::setorderv(x = mjrt_polgroup_meps, 
                      cols = c("date_id", "rcv_id", "pers_id", "mjrt_polgroup_id"))
cumulative_affinity = mjrt_polgroup_meps[, `:=`(
  cum_same = dplyr::cummean(is_same)),
  by = list(mjrt_polgroup_id, pers_id)
]
data.table::fwrite(x = cumulative_affinity[, list(rcv_id, mjrt_polgroup_id, 
                                                  pers_id, polgroup_id, cum_same)], 
                   file = here::here(
                     "data_out", "meps", "cumulative_affinity.csv") )
```


### Cumulative affinity (multiple MEPs)
We benchmark Manuela Ripa against Manfred Weber, to gain a better appreciation of the patterns within EPP.
In the plot below, every dot is a step in the cumulative metric.
We overlay a trend line on the dots to facilitate an understanding of the overall direction.
The x-axis covers the entire 10th Mandate thus far.
```{r}
#| fig-width: 8
#| fig-height: 5

# Subset data
plot_test = cumulative_affinity[
  mjrt_polgroup_id == 7018
  & pers_id %in% c(206158, 28229) # MANUELA_RIPA; MANFRED_WEBER 
] |> 
  join_meps_names()

# Plot
plot_test |> 
  ggplot(aes(x = rcv_id_int, y = cum_same, 
             colour = mep_name, group = mep_name)) +
  geom_point(alpha = 0.1) +
  geom_smooth(aes(fill = mep_name), se = TRUE) +
  labs(fill="MEP", colour="MEP",
       y = "Cumulative Similarity", x="Time") +
  scale_y_continuous(limits = c(0.5, 1),
                     labels = scales::percent) +
  scale_x_continuous(breaks = c(min(plot_test$rcv_id_int), 
                                max(plot_test$rcv_id_int)),
                     labels = c(min(plot_test$date), 
                                max(plot_test$date))) +
  # scale_fill_manual(values = polgroup_cols) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "top",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold"))
```


### Cumulative affinity (multiple Groups)
We can then focus on Manuela Ripa's patterns of alignment with both EPP and Renew.
The plot has the same structure as above.
```{r}
#| fig-width: 8
#| fig-height: 5

# Subset data
plot_test = cumulative_affinity[
  mjrt_polgroup_id %in% c(7035, 7018)
  & pers_id %in% c(206158), # MANUELA_RIPA
  list(rcv_id, polgroup_id = mjrt_polgroup_id, pers_id, is_same, date, date_id,
       rcv_id_int, cum_same)
] |> 
  join_polit_labs()

# Plot
plot_test |> 
  ggplot(aes(x = rcv_id_int, y = cum_same, 
             colour = political_group, 
             group = political_group)) +
  geom_point(alpha = 0.1) +
  geom_smooth(aes(fill = political_group), se = TRUE) +
  labs(fill="Political Group", colour="Political Group",
       y = "Cumulative Similarity", x="Time") +
  scale_y_continuous(limits = c(0.5, 1),
                     labels = scales::percent) +
  scale_x_continuous(breaks = c(min(plot_test$rcv_id_int), 
                                max(plot_test$rcv_id_int)),
                     labels = c(min(plot_test$date), 
                                max(plot_test$date))) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "top",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold"))
```


### Focus on Committees
We can dig deeper into trends by Committees.
Here we drop the time perspective, because in several Committees we would have only a handful of votes. 
Thus, we show the paired similarity by Committee.
This visualisation helps identify the areas where we have a greater similarity with the MEP compared to EPP, as the Committees are ranked by the difference between the similarity with Renew and EPP.
```{r}
#| fig-width: 8
#| fig-height: 7

#------------------------------------------------------------------------------#
rcvid_cmts <- data.table::fread(file = here::here(
  "data_out", "rcv", "rcvid_cmts_10.csv"))

plot_test = mjrt_polgroup_meps[mjrt_polgroup_id %in% c(7035, 7018)
                               & pers_id %in% c(206158), # MANUELA_RIPA
                               list(rcv_id, polgroup_id = mjrt_polgroup_id, pers_id, is_same)
] |> 
  # This results in many-to-many - it's OK!
  dplyr::inner_join(
    y = rcvid_cmts, #[committee_lab %in% c("AGRI", "ENVI", "FEMM", "LIBE")]
    by = "rcv_id"
  ) |> 
  dplyr::summarise(
    avg_similarity = mean(is_same, na.rm = TRUE), 
    .by = c(polgroup_id,committee_lab)
  )|> 
  join_polit_labs()

plot_rank = plot_test |> 
  tidyr::pivot_wider(id_cols = committee_lab,
                     names_from = political_group, values_from = avg_similarity) |> 
  dplyr::mutate(diff = PPE - Renew) |> 
  dplyr::arrange(diff) |> 
  pull(committee_lab)

plot_test |> 
  dplyr::mutate(committee_lab = factor(committee_lab, levels = plot_rank)) |> 
  ggplot(aes(x = political_group, y = avg_similarity, 
             group = committee_lab)) +
  geom_vline(xintercept = c(1, 2), colour="grey40") +
  geom_line(colour="grey70", alpha=0.8, linewidth = 2) +
  geom_point(aes(colour = political_group), size=4) +
  # ggrepel::geom_text_repel(aes(label = committee_lab)) +
  facet_wrap(~committee_lab, nrow=3) +
  labs(fill="Political Group", colour="Political Group",
       y = "Cumulative Similarity", x="") +
  scale_y_continuous(limits = c(min(plot_test$avg_similarity), 1.01),
                     labels = scales::percent) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "top",
        axis.text.x = element_blank(),
        strip.text.x = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold"))

#------------------------------------------------------------------------------#
# plot_test |> 
#   # This results in many-to-many - it's OK!
#   dplyr::inner_join(
#     y = rcvid_cmts[committee_lab %in% c("AGRI", "ENVI", "LIBE")],
#     by = "rcv_id"
#   ) |> 
#   ggplot(aes(x = rcv_id_int, y = cum_same, 
#              colour = political_group, 
#              group = political_group)) +
#   geom_point(alpha = 0.1) +
#   geom_smooth(aes(fill = political_group), se = TRUE) +
#   facet_grid(cols = vars(committee_lab), space = "free", scales = "free_x") +
#   labs(fill="Political Group", colour="Political Group",
#        y = "Cumulative Similarity", x="Time") +
#   scale_y_continuous(limits = c(0.5, 1),
#                      labels = scales::percent) +
#   scale_x_continuous(breaks = c(min(plot_test$rcv_id_int), 
#                                 max(plot_test$rcv_id_int)),
#                      labels = c(min(plot_test$date), 
#                                 max(plot_test$date))) +
#   theme_minimal() +
#   theme(plot.title.position = "plot",
#         plot.title = element_text(face = "bold"),
#         legend.position = "top",
#         # strip.text.y.right = element_text(angle = 0, face = "bold"),
#         axis.text.y = element_text(face = "bold"))
```
