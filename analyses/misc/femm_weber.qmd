---
title: "Weber in FEMM Analysis"
author:
  - Filipa TORRAO
  - Marco SCIPIONI
date: "`r Sys.Date()`"
format: 
  pdf:
    number-sections: true
    number-depth: 2
    shift-heading-level-by: -1
    colorlinks: true
    geometry:
      - top=5mm
      - right=10mm
      - bottom=20mm
      - left=10mm
      - heightrounded
      - landscape
editor_options: 
  chunk_output_type: console
execute:
  echo: false
  warning: false
---

## Introduction
```{r}
#| include: false

#------------------------------------------------------------------------------#
## Libraries -------------------------------------------------------------------
library(tidyverse)
library(tidytext)
library(data.table)
library(here)

# Hard code the start of the mandate ------------------------------------------#
mandate_starts <- "2019-07-01"
current_month = lubridate::month(x = Sys.Date(), label = TRUE, abbr = FALSE)
current_year = lubridate::year( x = Sys.Date() )


#------------------------------------------------------------------------------#
## Functions -------------------------------------------------------------------

# Mode ------------------------------------------------------------------------#
# https://stackoverflow.com/questions/2547402/how-to-find-the-statistical-mode
stat_mode <- function(x) {
  if ( length(x) <= 2 ) return(x[1])
  if ( anyNA(x) ) x = x[!is.na(x)]
  ux <- unique(x)
  ux[ which.max( tabulate( match(x, ux) ) ) ] }

# Load join functions ---------------------------------------------------------#
source(file = here::here("scripts_r", "join_functions.R") )

# Calculate Majorities --------------------------------------------------------#
source(file = here::here("scripts_r", "get_majority.R") )

# Cohesion rate ---------------------------------------------------------------#
source(file = here::here("scripts_r", "cohesionrate_function.R") )


#------------------------------------------------------------------------------#
## Graphics --------------------------------------------------------------------
# set theme globally for ggplots --------------------------------------------###
# https://stackoverflow.com/questions/34522732/changing-fonts-in-ggplot2
custom_theme = theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold", size = 26),
        legend.text = element_text(face="bold",  size = 22),
        plot.caption = element_text(size = 16),
        strip.text = element_text(face = "bold", size = 20, hjust = 0.5),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(colour = "grey30", linewidth = 0.1),
        panel.grid.minor.y = element_line(colour = "grey70"),
        axis.text = element_text(face="bold", size = 20),
        legend.position = "bottom")
theme_set(new = custom_theme)

# vote colours  -------------------------------------------------------------###
vote_colours <- c(For = '#00AEEF',
                  Against = '#BE3455',
                  Abstain = "#969696",
                  `Did not vote` = '#5D5CA4',
                  Absent = '#F47920')

# political groups colours ----------------------------------------------------#
polgroup_cols = c(`S&D` = "#EE3652",
                  ECR = "#0D88C3",
                  PfE = "#1A3153",
                  PPE = "#3C5979",
                  Renew = "#FFCC70",
                  `Verts/ALE` = "#19A24A",
                  `The Left` = "#733542",
                  ESN = "#000000",
                  NI = "#979797")
```


The objective of this note is to test how Manfred Weber votes on certain files
related with FEMM and gender issues. We look at 1) the times he did
not vote, despite being present; 2) the times he voted against the file
on final votes.

```{r}
#| include: false
#------------------------------------------------------------------------------#
## Data -------------------------------------------------------------------
# Full data
meps_rcv_mandate <- data.table::fread(
  file = here::here("data_out", "meps_rcv_mandate_all.csv"),
  verbose = TRUE, key = c("rcv_id", "pers_id") )
# Nominal change from GUE to The Left
meps_rcv_mandate[polgroup_id == 5151L, polgroup_id := 6259L] 

# Votes
pl_votes <- data.table::fread(
  file = here::here("data_out", "votes", "pl_votes_all.csv"))

rcv_decided_realization_of <- data.table::fread(
  file = here::here("data_out", "rcv", "rcv_decided_on_a_realization_of_all.csv"))

# List of RCV IDs and Voting Item IDs
rcv_inverse_consists_of<- data.table::fread(here::here(
  "data_out", "rcv", "rcv_inverse_consists_of_all.csv") )

votes_inverse_consists_of<- data.table::fread(here::here(
  "data_out", "votes", "votes_inverse_consists_of_all.csv") )

voteids_rcvs<- data.table::fread(here::here(
  "data_out", "votes", "voteids_rcvids_all.csv"))

pl_docs <- data.table::fread(here::here(
  "data_out", "docs_pl", "pl_docs.csv"))

# procedures_docs<- data.table::fread(here::here(
#   "data_out", "procedures", "procedures_docid_all.csv"))
# This comes from the `api_procedures.R`
procedures_created_a_realization_of <- data.table::fread(here::here(
  "data_out", "procedures", "procedures_created_a_realization_of.csv"))

# List of RCV IDs and Committees
rcvid_cmts <- data.table::fread(here::here(
  "data_out", "rcv", "rcvid_cmts_all.csv") )
# sort(unique(rcvid_cmts$committee_lab))
rcvid_cmts[committee_lab == "BUDE", committee_lab := "BUDG"]
rcvid_cmts <- data.table::fread(here::here(
  "data_out", "rcv", "rcvid_cmts_all.csv") )
# sort(unique(rcvid_cmts$committee_lab))
rcvid_cmts[committee_lab == "BUDE", committee_lab := "BUDG"]

#------------------------------------------------------------------------------#
# Hard code Groups
renew_group_ids <- political_groups$identifier[
  political_groups$label == "Renew"]

# Current MEPs configuration
meps_current <- data.table::fread(here::here(
  "data_out", "meps", "meps_current.csv") )

renew_partyids_current = unique(meps_current$natparty_id[
  meps_current$polgroup_id %in% renew_group_ids
])
```

```{r}
#| include: false
proc_ids_target = c(
  "eli/dl/proc/2024-2125", "eli/dl/proc/2024-2057","eli/dl/proc/2025-2780",
  "eli/dl/proc/2022-0426", "eli/dl/proc/2022-0400","eli/dl/proc/2022-0066",
  "eli/dl/proc/2021-0050","eli/dl/proc/2012-0299", "eli/dl/proc/2022-0401",
  "eli/dl/proc/2016-0062B", "eli/dl/proc/2016-0062R", "eli/dl/proc/2020-0011",
  "eli/dl/proc/2016-0062A", "eli/dl/proc/2021-2035", "eli/dl/proc/2020-2035",
  "eli/dl/proc/2023-2115", "eli/dl/proc/2022-2140", "eli/dl/proc/2022-2139",
  "eli/dl/proc/2022-2138", "eli/dl/proc/2021-2253", "eli/dl/proc/2021-2243",
  "eli/dl/proc/2021-2170", "eli/dl/proc/2021-2080", "eli/dl/proc/2021-2039",
  "eli/dl/proc/2021-2020", "eli/dl/proc/2021-2003", "eli/dl/proc/2020-2215",
  "eli/dl/proc/2020-2121", "eli/dl/proc/2020-2029", "eli/dl/proc/2019-2169",
  "eli/dl/proc/2019-2168", "eli/dl/proc/2019-2167", "eli/dl/proc/2019-2166",
  "eli/dl/proc/2019-2164", "eli/dl/proc/2024-2655", "eli/dl/proc/2023-2973",
  "eli/dl/proc/2022-2839", "eli/dl/proc/2022-2742", "eli/dl/proc/2022-2665", 
  "eli/dl/proc/2022-2633", "eli/dl/proc/2021-2925", "eli/dl/proc/2021-2910",
  "eli/dl/proc/2021-2509", "eli/dl/proc/2020-2876", "eli/dl/proc/2019-2855",
  "eli/dl/proc/2019-2891"
)

# How many of these are in the procedure file?
all(proc_ids_target %in% unique(procedures_created_a_realization_of$id))
procedures_docid = procedures_created_a_realization_of[
  id %in% proc_ids_target
  & doc_type == "plenary_doc",
  list(id, created_a_realization_of)] |> 
  dplyr::left_join(
    y = pl_docs[, list(identifier, doc_id)],
    by = c("created_a_realization_of" = "identifier")
  )

procedures_docid_rcvid = procedures_docid |> 
  left_join(
    y = pl_votes[, list(rcv_id, doc_id)],
    by = "doc_id"
  )
# length(unique(procedures_docid_rcvid$rcv_id[
#   !is.na(procedures_docid_rcvid$rcv_id)
# ]))
```


```{r}
#| include: false
rcv_ids_relevant_gender<- procedures_docid_rcvid$rcv_id[!is.na(procedures_docid_rcvid$rcv_id)]

rcv_ids_relevant_gender_final<- pl_votes$rcv_id[
  which(pl_votes$is_final == 1L & pl_votes$rcv_id %in% rcv_ids_relevant_gender) 
]

rcvs_weber_no_vote<- meps_rcv_mandate$rcv_id[
  which(meps_rcv_mandate$pers_id == 28229 &
          meps_rcv_mandate$rcv_id %in% rcv_ids_relevant_gender &
          meps_rcv_mandate$result == -2L)
]

detailed_info_no_vote<- pl_votes[which(pl_votes$rcv_id %in% rcvs_weber_no_vote),
                                 c("activity_date", "number_of_votes_abstention",
                                   "number_of_votes_against", "number_of_votes_favor",
                                   "activity_label_en", "decision_outcome","doc_id")]
colnames(detailed_info_no_vote)<- c("date", "abstentions", "against",
                                               "favour", "label_en", "outcome",
                                    "doc")

rcvs_weber_final_against<- meps_rcv_mandate$rcv_id[
  which(meps_rcv_mandate$pers_id == 28229 &
          meps_rcv_mandate$rcv_id %in% rcv_ids_relevant_gender_final &
          meps_rcv_mandate$result == -1L)
]


detailed_info_vote_against_final<- pl_votes[which(pl_votes$rcv_id %in% rcvs_weber_final_against), c("activity_date", "number_of_votes_abstention",
                                                                                                    "number_of_votes_against", "number_of_votes_favor",
                                                                                                    "activity_label_en", "decision_outcome","doc_id")]

colnames(detailed_info_vote_against_final)<- c("date", "abstentions", "against",
                                               "favour", "label_en","outcome",
                                               "doc")

```

We do two separate tables: one for the RCVs where he was present but did not vote:

```{r}
detailed_info_no_vote|> 
  dplyr::mutate(dplyr::across(where(is.character), ~gsub("[\r\n]+", " ", .x))) |> 
  knitr::kable(align = "c")
```


And another table for the RCVs where he was present and voted against on final votes:

```{r}
detailed_info_vote_against_final|> 
  dplyr::mutate(dplyr::across(where(is.character), ~gsub("[\r\n]+", " ", .x))) |> 
  knitr::kable(align = "c")
```


