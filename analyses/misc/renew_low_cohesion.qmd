---
title: "Renew's Metrics and VLs"
author:
  - Marco SCIPIONI
date: "`r Sys.Date()`"
format: 
  html:
    embed-resources: true
    toc: true
    toc-depth: 3
    toc-title: Contents
    number-sections: true
    colorlinks: true
editor_options: 
  chunk_output_type: console
execute:
  echo: false
  warning: false
---

## Intro
```{r}
#| include: false

script_starts <- Sys.time()

###--------------------------------------------------------------------------###
## Libraries -------------------------------------------------------------------
if ( !require("pacman") ) install.packages("pacman")
pacman::p_load(char = c("data.table", "dplyr", "forcats", "ggplot2", "here",
                        "lubridate", "janitor", "stringr", "tidyr", "tidyselect",
                        "tidytext") )


# Hard code the start of the mandate ------------------------------------------#
mandate_starts <- as.Date("2024-07-14")


###--------------------------------------------------------------------------###
## Functions -------------------------------------------------------------------

# Mode ------------------------------------------------------------------------#
# https://stackoverflow.com/questions/2547402/how-to-find-the-statistical-mode
stat_mode <- function(x) {
  if ( length(x) <= 2 ) return(x[1])
  if ( anyNA(x) ) x = x[!is.na(x)]
  ux <- unique(x)
  ux[ which.max( tabulate( match(x, ux) ) ) ] }

# Load join functions ---------------------------------------------------------#
source(file = here::here("scripts_r", "join_functions.R") )

# Calculate Majorities --------------------------------------------------------#
source(file = here::here("scripts_r", "get_majority.R") )

# Cohesion rates --------------------------------------------------------------#
source(file = here::here("scripts_r", "cohesionrate_function.R") )


###--------------------------------------------------------------------------###
## Graphics --------------------------------------------------------------------
# set theme globally for ggplots --------------------------------------------###
# https://stackoverflow.com/questions/34522732/changing-fonts-in-ggplot2
theme_set(theme_minimal(base_size = 10, base_family = "roboto") )


# vote colours  -------------------------------------------------------------###
vote_colours <- c(For = '#00AEEF',
                  Against = '#BE3455',
                  Abstain = "#969696",
                  `Did not vote` = '#5D5CA4',
                  Absent = '#F47920')

# political groups colours ----------------------------------------------------#
polgroup_cols = c(`S&D` = "#EE3652",
                  ECR = "#0D88C3",
                  PfE = "#1A3153",
                  PPE = "#3C5979",
                  Renew = "#FFCC70",
                  `Verts/ALE` = "#19A24A",
                  `The Left` = "#733542",
                  ESN = "#000000",
                  NI = "#979797")
```

The objective of this short note is to investigate Renew's metrics in the area of Parliamentary Work in the light of the Group's Lines as expressed in the Voting Lists.

**Please keep in mind** that this document is the *sole property of the Renew Group* and *should not be disseminated to other people or organisations*.


## Data and Methods
```{r}
#| include: false

###--------------------------------------------------------------------------###
## Read data -------------------------------------------------------------------
# check whether data already exists
if ( file.exists( here::here(
  "data_out", "vl_vote", "vl_vote_rcv.csv") ) ) {
  # get date of last version
  mtime <- as.Date(file.info(
    here::here("data_out", "vl_vote", "vl_vote_rcv.csv"))[["mtime"]])
  if ( (Sys.Date() - mtime) < 1L ) {
    # read data ---------------------------------------------------------------#
    vl_vote_rcv <- data.table::fread(file = here::here(
      "data_out", "vl_vote", "vl_vote_rcv.csv") )
  } else {
    # If the data is older than today, stop and recreate --------------#
    stop("Your data on disk is old. Go back and refresh it.")
  }
} else {
  # If the data is not there, create data from source -------------------------#
  stop( 
    "You don't have the data to run this. Go back and run the script at /scripts_r/merge_vl_vote_results.qmd") }
rm(mtime)

# Recode data 
vl_vote_rcv[vote == "-", re_vote := -1L]
vl_vote_rcv[vote == "+", re_vote := 1L]
vl_vote_rcv[vote == "free vote", re_vote := NA_integer_]
vl_vote_rcv[, rcv_id := as.integer( gsub(pattern = "^.*DEC-", replacement = "", 
                                         x = event_dec_itm_id, perl = TRUE) ) ]
dates_tokeep <- unique(vl_vote_rcv$date)

# Subset to 10th mandate and available dates
pl_votes <- data.table::fread(
  file = here::here("data_out", "votes", "pl_votes_10.csv"),
  na.strings = c(NA_character_, "") 
)

meps_rcv_mandate <- data.table::fread(
  file = here::here("data_out", "meps_rcv_mandate_10.csv"),
  verbose = TRUE, key = c("rcv_id", "pers_id"), 
  na.strings = c(NA_character_, "") )

meps_current = data.table::fread(here::here(
  "data_out", "meps", "meps_current.csv") )


#------------------------------------------------------------------------------#
# List of RCV IDs and Committees
rcvid_cmts <- data.table::fread(here::here(
  "data_out", "rcv", "rcvid_cmts_10.csv") )
rcvid_cmts[committee_lab == "BUDE", committee_lab := "BUDG"]

# Number of RCVs
# length( unique(meps_rcv_mandate$rcv_id) )
# Number of RCVs by Committee (check for Joint Committee)
# rcvid_cmts[, .N, by = rcv_id][order(N)]

# what are the RCVs without DOC ID?
rcv_missing_doc <- unique(meps_rcv_mandate$rcv_id)[
  !unique(meps_rcv_mandate$rcv_id) %in% unique(rcvid_cmts$rcv_id)]

# These should be ordre du jour, election of commission, etc.
# pl_votes[rcv_id %in% rcv_missing_doc]

# Get vote labels
votes_labels_10 <- data.table::fread(here::here(
  "data_out", "votes", "votes_labels_10.csv") )

pl_session_docs_votes <- data.table::fread(here::here(
  "data_out", "votes", "pl_session_docs_votes_10.csv") )

tally_bygroup_byrcv <- data.table::fread(here::here(
  "data_out", "aggregates", "tally_bygroup_byrcv_10.csv") ) |> 
  dplyr::select(-result, -mandate ) |> 
  tidyr::pivot_wider(names_from = result_fct, values_from = tally)


#------------------------------------------------------------------------------#
# get length objects
n_votes <- nrow(pl_votes)
n_rcv <- length( unique( meps_rcv_mandate$rcv_id ) )


# Parameters
renew_polgroup_id <- 7035L

renew_current_meps = unique(meps_current$pers_id[
  meps_current$polgroup_id == renew_polgroup_id
])
renew_current_parties = unique(meps_current$natparty_id[
  meps_current$polgroup_id == renew_polgroup_id
])


###--------------------------------------------------------------------------###
# Read in function
source(file = here::here("scripts_r", "cohesionrate_function.R") )
# convert to factor - essential for tabulate
meps_rcv_mandate[, result_fct := factor(result,
                                        levels = -3L : 1L,
                                        labels = c("absent", "no_vote", "against",
                                                   "abstain", "for") ) ]
```


### Cohesion Rates by Final
```{r}
#| fig-width: 8
#| fig-height: 5

#------------------------------------------------------------------------------#
# Merge RCV with Finals -------------------------------------------------------#
meps_rcv_mandate <- pl_votes[, list(
  is_final, rcv_id
)][
  meps_rcv_mandate, 
  on = "rcv_id"
]

# meps_rcv_mandate[,
#   .N,
#   by = list(activity_date, result)
# ][order(activity_date)]


# Colours ---------------------------------------------------------------------#
cols_final <- c(Final = "#0868ac", `Not Final` = "#d7301f")

# Calculate final votes -------------------------------------------------------#
cohesion_final_dt <- meps_rcv_mandate[
  result >= -1L, # only official votes
  list(
    cohesion = cohesion_hn(result_fct),
    max_mode = max( tabulate(result_fct) ),
    tot_votes = sum( tabulate(result_fct) ) 
  ),
  by = list(rcv_id, polgroup_id, is_final) 
] |> 
  join_polit_labs()
```



## Final RCVs with Lowest Cohesion
```{r}
# Sort DT 
data.table::setkeyv(
  x = cohesion_final_dt, 
  cols = c("polgroup_id", "cohesion") 
)


# Filter
renew_lowest_final_rcvs = cohesion_final_dt[
  !is.na(cohesion)
  & cohesion < 100
  & is_final == 1L
  & political_group == "Renew",
  # head(.SD, 100L)
] |> 
  dplyr::left_join(
    y = cohesion_final_dt[
      !is.na(cohesion)
      & political_group == "S&D",
      list(`S&D Cohesion` = cohesion, rcv_id)],
    by = "rcv_id"
  ) |> 
  dplyr::left_join(
    y = cohesion_final_dt[
      !is.na(cohesion)
      & political_group == "PPE",
      list(`EPP Cohesion` = cohesion, rcv_id)],
    by = "rcv_id"
  ) |> 
  dplyr::left_join(
    y = tally_bygroup_byrcv,
    by = c("polgroup_id", "rcv_id")
  ) |> 
  dplyr::left_join(
    y = pl_votes[, list(activity_date, activity_label_fr, referenceText_fr,
                        headingLabel_fr, responsible_organization_label_fr,
                        doc_id, rcv_id,
                        inverse_consists_of)],
    by = "rcv_id") |> 
  # dplyr::left_join(
  #   y = votes_labels[, list(activity_id, vote_label_fr)],
  #   by = c("inverse_consists_of" = "activity_id")
  # ) |> 
  dplyr::left_join(
    y = pl_session_docs_votes[, list(event_vot_itm_id, title_dcterms_fr)],
    by = c("inverse_consists_of" = "event_vot_itm_id")
  ) |> 
  dplyr::left_join(
    y = vl_vote_rcv[, list(rcv_id, remarks, vote, renew_indication = renew_vote)],
    by = "rcv_id"
  ) |> 
  dplyr::left_join(
    y = rcvid_cmts,
    by = "rcv_id"
  ) |> 
  dplyr::mutate(
    is_freevote = ifelse(
      test = grepl(pattern = "free vote", x = vote, ignore.case = TRUE),
      yes = 1L, no = 0L),
    is_keyvote = ifelse(
      test = grepl(pattern = "key vote", x = remarks, ignore.case = TRUE),
      yes = 1L, no = 0L),
    cohesion = round(cohesion, digits = 1),
    `EPP Cohesion` = round(`EPP Cohesion`, digits = 1),
    `S&D Cohesion` = round(`S&D Cohesion`, digits = 1),
    rank = dplyr::row_number()
  ) |> 
  dplyr::select(
    rank, activity_date, title_dcterms_fr, committee_lab, doc_id, 
    remarks, is_freevote, is_keyvote, renew_indication,
    `for`, against, abstain, no_vote, absent, tot_votes, 
    `Renew Cohesion` = cohesion, `EPP Cohesion`, `S&D Cohesion`)
```


## Not Final RCVs with Lowest Cohesion
```{r}
# Filter
renew_lowest_nofinal_rcvs = cohesion_final_dt[
  !is.na(cohesion)
  & cohesion < 70
  & is_final == 0L
  & political_group == "Renew",
  # head(.SD, 100L)
] |> 
  dplyr::left_join(
    y = cohesion_final_dt[
      !is.na(cohesion)
      & political_group == "S&D",
      list(`S&D Cohesion` = cohesion, rcv_id)],
    by = "rcv_id"
  ) |> 
  dplyr::left_join(
    y = cohesion_final_dt[
      !is.na(cohesion)
      & political_group == "PPE",
      list(`EPP Cohesion` = cohesion, rcv_id)],
    by = "rcv_id"
  ) |> 
  dplyr::left_join(
    y = tally_bygroup_byrcv,
    by = c("polgroup_id", "rcv_id")
  ) |> 
  dplyr::left_join(
    y = pl_votes[, list(activity_date, activity_label_fr, referenceText_fr,
                        headingLabel_fr, responsible_organization_label_fr, doc_id, rcv_id,
                        inverse_consists_of)],
    by = "rcv_id") |>
  # dplyr::left_join(
  #   y = votes_labels[, list(activity_id, vote_label_fr)],
  #   by = c("inverse_consists_of" = "activity_id")
  # ) |> 
  dplyr::left_join(
    y = pl_session_docs_votes[, list(event_vot_itm_id, title_dcterms_fr)],
    by = c("inverse_consists_of" = "event_vot_itm_id")
  ) |> 
  dplyr::left_join(
    y = vl_vote_rcv[, list(rcv_id, remarks, vote, renew_indication = renew_vote)],
    by = "rcv_id"
  ) |> 
  dplyr::left_join(
    y = rcvid_cmts,
    by = "rcv_id"
  ) |> 
  dplyr::mutate(
    is_freevote = ifelse(
      test = grepl(pattern = "free vote", x = vote, ignore.case = TRUE),
      yes = 1L, no = 0L),
    is_keyvote = ifelse(
      test = grepl(pattern = "key vote", x = remarks, ignore.case = TRUE),
      yes = 1L, no = 0L),
    cohesion = round(cohesion, digits = 1),
    `EPP Cohesion` = round(`EPP Cohesion`, digits = 1),
    `S&D Cohesion` = round(`S&D Cohesion`, digits = 1),
    rank = dplyr::row_number()
  ) |> 
  dplyr::select(
    rank, activity_date, title_dcterms_fr, committee_lab, doc_id, 
    responsible_organization_label_fr,
    remarks, is_freevote, is_keyvote, renew_indication,
    `for`, against, abstain, no_vote, absent, tot_votes, 
    `Renew Cohesion` = cohesion, `EPP Cohesion`, `S&D Cohesion`)
```

```{r}
dir.create(path = here::here("data_out", "tmp"), recursive = TRUE)
# Include all DFs as Excel Sheets
writexl::write_xlsx(
  x = list(
    Finals = renew_lowest_final_rcvs, 
    `Not Finals` = renew_lowest_nofinal_rcvs
  ), 
  path = here::here("data_out", "tmp", "renew_low_cohesion.xlsx")
)
```

## All Groups
```{r}
groups_cohesion = cohesion_final_dt[
  !is.na(cohesion)
] |> 
  dplyr::left_join(
    y = tally_bygroup_byrcv,
    by = c("polgroup_id", "rcv_id")
  ) |> 
  dplyr::left_join(
    y = pl_votes[, list(activity_date, responsible_organization_label_fr, doc_id,
                        rcv_id, inverse_consists_of)],
    by = "rcv_id") |> 
  # dplyr::left_join(
  #   y = votes_labels[, list(activity_id, vote_label_fr)],
  #   by = c("inverse_consists_of" = "activity_id")
  # ) |> 
  dplyr::left_join(
    y = pl_session_docs_votes[, list(event_vot_itm_id, title_dcterms_fr)],
    by = c("inverse_consists_of" = "event_vot_itm_id")
  ) |> 
  dplyr::left_join(
    y = vl_vote_rcv[, list(rcv_id, remarks, vote, renew_indication = renew_vote)],
    by = "rcv_id"
  ) |> 
  dplyr::left_join(
    y = rcvid_cmts,
    by = "rcv_id"
  ) |> 
  dplyr::arrange(political_group, cohesion) |> 
  dplyr::mutate(rank = dplyr::row_number(), .by = "political_group") |>
  dplyr::mutate(
    is_freevote = ifelse(
      test = grepl(pattern = "free vote", x = vote, ignore.case = TRUE),
      yes = 1L, no = 0L),
    is_keyvote = ifelse(
      test = grepl(pattern = "key vote", x = remarks, ignore.case = TRUE),
      yes = 1L, no = 0L),
    cohesion = round(cohesion, digits = 1),
    dplyr::across(.cols = c("for", "against", "abstain", "no_vote", "absent"), 
                  .fns = ~tidyr::replace_na(data = ., replace = 0L))
  ) |> 
  dplyr::select(
    rank, activity_date, title_dcterms_fr, committee_lab, doc_id, 
    responsible_organization_label_fr, remarks, is_freevote, is_keyvote,
    renew_indication, political_group,
    `for`, against, abstain, no_vote, absent, tot_votes, cohesion)

data.table::fwrite(x = groups_cohesion, here::here(
  "data_out", "tmp", "groups_cohesion.csv"))
```
