---
title: "PA vote analysis"
subtitle: "Today's Votes (`r Sys.Date()`)"
author:
  - Marco SCIPIONI
format: 
  html:
    embed-resources: true
    toc: true
    toc-depth: 3
    toc-title: Contents
    number-sections: true
    colorlinks: true
  # pdf:
  #   toc: true
  #   toc-depth: 2
  #   toc-title: Contents
  #   number-sections: true
  #   colorlinks: true
  #   geometry:
  #     - top=10mm
  #     - bottom=20mm
  #     - left=10mm
  #     - right=10mm
editor_options: 
  chunk_output_type: console
execute:
  echo: false
  warning: false
---

## Main findings

```{r}
#| include: false

source(file = here::here("analyses", "metrics", "vote_metrics_day.R"))
```



## Cohesion Rates
### Overall cohesion rates
Here we calculate the average cohesion rate by Political Groups for today's session (right-hand side of the plot).
To better appreciate the results, we contrast today's results with the legislature (left-hand side of the plot). 
```{r}
#| fig-width: 9
#| fig-height: 5

#------------------------------------------------------------------------------#
plot_rank <- cohesion_bypolgroup_avg$political_group[
  cohesion_bypolgroup_avg$period == "10th legislature"]

# Plot ------------------------------------------------------------------------#
cohesion_bypolgroup_avg |>
  ggplot(aes(x = factor(political_group, levels = plot_rank),
             y = avg) ) +
  geom_col(colour = "black", fill = "grey80", linewidth = 0.1) +
  geom_text(aes(label = avg), size = 3, nudge_y = 5) +
  facet_wrap(~period) +
  ylim(0, 105) +
  coord_flip() +
  labs(x="", y="Average Cohesion Rates (%)", fill="",
       title = "Cohesion Rates by EP Political Groups - Today and Full Mandate",
       caption = "Source: EP. Notes: data is relative to RCVs in Plenary") +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "top",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold"))
```


### Cohesion rates by final
The plot below includes final votes and other votes (i.e. amendments, split, and separate votes) in the metric breakdown.
```{r}
#| fig-width: 9
#| fig-height: 6

#------------------------------------------------------------------------------#
plot_rank <- cohesion_bypolgroup_final$political_group[
  cohesion_bypolgroup_final$period == "10th legislature"
  & cohesion_bypolgroup_final$is_final == "Final Votes"]

# Plot ------------------------------------------------------------------------#
cohesion_bypolgroup_final |>
  ggplot(aes(x = factor(political_group, levels = plot_rank), y = avg) ) +
  geom_col(aes(fill = factor(is_final), group = factor(is_final)),
           colour = "black", linewidth = 0.1, position = "dodge") +
  geom_text(aes(label = avg, group = factor(is_final)), size = 3,
            hjust = -0.1, position = position_dodge(width = 1), inherit.aes = TRUE) +
  facet_wrap(~period) +
  ylim(0, 105) +
  scale_fill_manual(values = cols_palette) +
  coord_flip() +
  labs(x="", y="Average Cohesion Rates (%)", fill="",
       title = "Cohesion Rates by EP Political Groups for Final and Other Votes - Today and Full Mandate",
       caption = "Source: EP. Notes: data is relative to RCVs in Plenary") +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "top",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold") )
```


<!-- ### Cohesion rates by Committee -->
<!-- **NOT CURRENTLY RUNNING THIS AS WE DON'T HAVE ENOUGH DATA** -->
```{r}
#| eval: false
#| fig-width: 8
#| fig-height: 12

###--------------------------------------------------------------------------###
# List of RCV IDs and Doc IDs -------------------------------------------------#
rcvid_docid_all <- data.table::fread( here::here(
  "data_out", "rcv", "rcvid_docid_10.csv"),
  na.strings = c(NA_character_, "") ) 

# Committees ------------------------------------------------------------------#
plenary_docs_committee <- data.table::fread( here::here(
  "data_out", "docs_pl", "plenary_docs_committee.csv"),
  select = c("identifier", "committee_lab", "doc_id"),
  na.strings = c(NA_character_, "") )

rcvid_docid_cmt <- rcvid_docid_all |> 
  dplyr::left_join(
    y = plenary_docs_committee,
    by = "doc_id"
  )


#------------------------------------------------------------------------------#
cohesion_bycommittee <- cohesion_dt |> 
  # RCVs and DOC IDs ----------------------------------------------------------#
  dplyr::left_join(
    y = rcvid_docid_all,
    by = "rcv_id") |> 
  # DOC IDs and Committees ----------------------------------------------------#
  dplyr::left_join(
    y = plenary_docs_committee[, list(committee_lab, doc_id) ],
    by = "doc_id" ) 

cohesion_bycommittee[
  !is.na(committee_lab),
  list(avg_cohesion = mean(cohesion) ),
  by = list(political_group, committee_lab)] |> 
  dplyr::mutate(political_group = reorder_within(
    political_group, avg_cohesion, committee_lab) ) |>
  ggplot(aes(x=political_group, y = avg_cohesion)) +
  geom_col(colour = "black", fill = "grey80", linewidth = 0.1) +
  facet_wrap(~committee_lab, scales = "free_y", ncol = 2) +
  coord_flip() +
  labs(x="", y="Average Cohesion Rates (%)", fill="",
       title = "Cohesion Rates by Committees, 9th mandate",
       caption = "Source: EP. Notes: data is relative to RCVs in Plenary") +  
  scale_x_reordered() +
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "top",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold"))
# ggsave(filename = here::here("figures", "cohesion_bycommittee.pdf"),
#        device = "pdf", dpi = 300, height = 8, width = 12)
```


## Where were we less cohesive?
The plots above were showing the average cohesion rates.
However, as mentioned above, our formula for cohesion rates gives us back a distribution of values.
<!-- The plot below illustrates such distribution.  -->
<!-- Every dot is a vote - finals are larger and blue, non final are smaller and red -, and the thick black line is the average cohesion rate for every Group (which was also displayed in the Section above). -->
```{r}
#| fig-width: 8
#| fig-height: 6

library(ggiraph)

plt = cohesion_today |> 
  na.omit() |> 
  dplyr::left_join(
    y = votes_today[, list(rcv_id, activity_label_mul)],
    by = "rcv_id") |> 
  dplyr::mutate(
    is_final_fct = ifelse(test = is_final == 1L,
                          yes = "Final", no = "Not Final"),
    activity_label_mul = gsub(pattern = "'", replacement = " ", 
                              x = activity_label_mul) ) |>
  ggplot(aes(x=fct_rev(political_group), y = cohesion) ) +
  stat_summary(fun = mean, geom = "crossbar", linewidth=0.3) +
  ggiraph::geom_jitter_interactive(
    aes(colour = is_final_fct, size = is_final_fct,
        tooltip = paste(rcv_id, activity_label_mul, sep = "\n"),
        data_id = paste(rcv_id, activity_label_mul, sep = "\n") ),
    width = 0.2, height = 0, alpha = 0.7) +
  # geom_jitter(aes(colour = is_final_fct, size = is_final_fct),
  #             width = 0.2, height = 0, alpha = 0.7) +
  # scale_colour_manual(values = cols_palette) +
  scale_size_manual(values = c(3, 1)) +
  coord_flip() +
  labs(x="", y="Cohesion Rates (%)", size="", colour = "",
       title = "Cohesion Rates by EP Political Groups and Final Vote - Today and Full Mandate",
       caption = "Source: EP. Notes: data is relative to RCVs in Plenary") +  
  guides(fill = guide_legend(nrow = 1)) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        plot.title = element_text(face = "bold"),
        legend.position = "top",
        # strip.text.y.right = element_text(angle = 0, face = "bold"),
        axis.text.y = element_text(face = "bold") )

ggiraph::girafe(ggobj = plt)
```

Now we can check where our Group has performed the worst.
In the table below we isolate the ten RCVs with the lowest cohesion rate (provided that they were below 50%).
```{r}
worst_cohesion |> 
  dplyr::filter(cohesion < 50) |> 
  knitr::kable(align = "c")
```



## Data and Methods
The objective of this short note is to investigate groups' cohesion during the EP's last Plenary Session.

We include in our analysis all votes taken by roll-call votes (RCVs) in the last Plenary Session as well as, for comparative purposes, data for the entire 10th legislature 14 July 2024.
We currently have `r n_rcv_tot` RCVs in our database for this legislature.
It is important to note that the EP recognises different forms of voting - such as *raise of hands*, or *electronic votes* - which are not included in this analysis. 
As a rough approximation, about `r round(n_rcv_tot/n_votes_tot*100)`% of the votes during this mandate have been taken by RCV.
In today's session, we had `r n_votes_today` votes and `r n_rcv_today` RCVs. 

**Please keep in mind** that this document is the *sole property of the Renew Group* and *should not be disseminated to other people or organisations*.


{{< pagebreak >}}

## ANNEX: List of Renew MEPs who did not vote albeit present
```{r}
rcv_today[
  result == -2L
  & polgroup_id == renew_polgroup_id,
  list(pers_id, rcv_id)] |> 
  join_meps_names() |> 
  dplyr::left_join(
    y = votes_today[, list(rcv_id, activity_label_mul)],
    by = "rcv_id") |> 
  dplyr::select(-pers_id) |> 
  knitr::kable(align = "c")
```
